name: Verify Disposable Domains

on:
  # Run every 7 hours
  schedule:
    - cron: "0 */7 * * *"

  # Manual trigger from Actions tab or PR
  workflow_dispatch:
    inputs:
      max_attempts:
        description: "Maximum verification attempts"
        required: false
        default: "50"
      commit_screenshots:
        description: "Commit screenshots back to branch"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

  # Run on PRs that modify the blocklist
  pull_request:
    paths:
      - "disposable_email_blocklist.conf"
      - "scripts/verify_domains.py"

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours max
    # Run for: cron, manual trigger, or PRs from Manas1820:chore/update-blocklist
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && 
       github.head_ref == 'chore/update-blocklist' &&
       github.event.pull_request.head.repo.owner.login == 'Manas1820')

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Run domain verification
        id: verify
        env:
          CI: "true"
          MAX_ATTEMPTS: ${{ github.event.inputs.max_attempts || '100' }}
          MAX_NO_RESULTS: "30"
        run: |
          python scripts/verify_domains.py 2>&1 | tee verification.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Upload screenshots as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: domain-screenshots
          path: |
            domain_screenshots/*.png
            domain_screenshots/results.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload verification log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verification-log
          path: verification.log
          retention-days: 7

      - name: Generate summary
        if: always()
        run: |
          echo "## Domain Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f domain_screenshots/results.json ]; then
            VERIFIED=$(jq -r '.verified_domains' domain_screenshots/results.json)
            TOTAL=$(jq -r '.total_domains' domain_screenshots/results.json)
            echo "**Verified:** ${VERIFIED}/${TOTAL} domains" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### Verified Domains" >> $GITHUB_STEP_SUMMARY
            jq -r '.verified[]' domain_screenshots/results.json | while read domain; do
              echo "- ‚úÖ ${domain}" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            
            MISSING_COUNT=$(jq -r '.missing | length' domain_screenshots/results.json)
            if [ "$MISSING_COUNT" -gt 0 ]; then
              echo "### Missing Domains (${MISSING_COUNT})" >> $GITHUB_STEP_SUMMARY
              jq -r '.missing[]' domain_screenshots/results.json | while read domain; do
                echo "- ‚ùå ${domain}" >> $GITHUB_STEP_SUMMARY
              done
            fi
          else
            echo "No results file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit screenshots (if enabled)
        if: github.event.inputs.commit_screenshots == 'true' && github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -d domain_screenshots ] && [ "$(ls -A domain_screenshots/*.png 2>/dev/null)" ]; then
            git add domain_screenshots/*.png
            git add domain_screenshots/results.json || true
            
            if git diff --staged --quiet; then
              echo "No new screenshots to commit"
            else
              SCREENSHOT_COUNT=$(git diff --staged --name-only | grep -c '.png' || echo 0)
              git commit -m "Add ${SCREENSHOT_COUNT} verified domain screenshots [skip ci]"
              git push
              echo "Committed ${SCREENSHOT_COUNT} screenshots"
            fi
          else
            echo "No screenshots directory or files found"
          fi

  # Job to comment on PR with results
  comment:
    runs-on: ubuntu-latest
    needs: verify
    if: >
      github.event_name == 'pull_request' && 
      github.head_ref == 'chore/update-blocklist' &&
      github.event.pull_request.head.repo.owner.login == 'Manas1820'

    permissions:
      pull-requests: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: domain-screenshots
          path: screenshots
        continue-on-error: true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## üîç Domain Verification Results\n\n';

            try {
              const results = JSON.parse(fs.readFileSync('screenshots/results.json', 'utf8'));
              body += `**Verified:** ${results.verified_domains}/${results.total_domains} domains\n\n`;
              
              if (results.verified.length > 0) {
                body += '### ‚úÖ Verified Domains\n';
                results.verified.forEach(d => body += `- \`${d}\`\n`);
                body += '\n';
              }
              
              if (results.missing.length > 0) {
                body += `### ‚ùå Not Found (${results.missing.length})\n`;
                body += '<details><summary>Click to expand</summary>\n\n';
                results.missing.forEach(d => body += `- \`${d}\`\n`);
                body += '</details>\n';
              }
              
              body += '\nüì¶ Screenshots available in workflow artifacts';
            } catch (e) {
              body += 'No verification results available. Check workflow logs for details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
