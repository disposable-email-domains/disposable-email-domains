name: Verify Disposable Domains

on:
  # Run every 7 hours
  schedule:
    - cron: "0 */7 * * *"

  # Manual trigger from Actions tab or PR
  workflow_dispatch:
    inputs:
      max_attempts:
        description: "Maximum verification attempts"
        required: false
        default: "100"

  # Run on PRs that modify the blocklist
  pull_request:
    paths:
      - "disposable_email_blocklist.conf"
      - "scripts/verify_domains.py"

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours max
    # Run for: cron, manual trigger, or PRs from Manas1820:chore/update-blocklist
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && 
       (github.head_ref == 'Manas1820:chore/update-blocklist' || github.head_ref == 'chore/update-blocklist') &&
       github.event.pull_request.head.repo.owner.login == 'Manas1820')

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event.pull_request.head.sha || github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Run domain verification
        id: verify
        env:
          MAX_ATTEMPTS: ${{ github.event.inputs.max_attempts || '1000' }}
          MAX_NO_RESULTS: "100"
        run: |
          python scripts/verify_domains.py 2>&1 | tee verification.log

      - name: Upload verification log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verification-log
          path: verification.log
          retention-days: 7

      - name: Generate summary
        if: always()
        run: |
          echo "## üîç Domain Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract and show final results
          if grep -q "RESULTS:" verification.log; then
            RESULTS=$(grep "RESULTS:" verification.log | head -1 | sed 's/.*RESULTS://')
            echo "### üìä Final Results" >> $GITHUB_STEP_SUMMARY
            echo "**$RESULTS**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show skipped domains count
          if grep -q "Skipping.*domains with existing screenshots" verification.log; then
            SKIPPED=$(grep "Skipping.*domains with existing screenshots" verification.log | head -1)
            echo "‚ÑπÔ∏è $SKIPPED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # List found domains
          echo "### ‚úÖ Found Domains" >> $GITHUB_STEP_SUMMARY
          FOUND_COUNT=$(grep -c "MATCH FOUND:" verification.log || echo "0")
          if [ "$FOUND_COUNT" -gt 0 ]; then
            grep "MATCH FOUND:" verification.log | while read -r line; do
              DOMAIN=$(echo "$line" | sed 's/.*MATCH FOUND: \([^ ]*\).*/\1/')
              echo "- \`$DOMAIN\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "_No new domains found in this run_" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show not found domains if present
          if grep -q "Not found" verification.log; then
            echo "### ‚ùå Not Found" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Click to expand</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            NOT_FOUND=$(grep "Not found" verification.log | head -1 | sed "s/.*Not found ([^)]*): \['\([^']*\)'.*/\1/" | tr "', " "\n" | grep -v "^$")
            echo "$NOT_FOUND" | while read -r domain; do
              if [ -n "$domain" ]; then
                echo "- \`$domain\`" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show full log
          echo "### üìã Full Log" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Click to expand log output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat verification.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # Job to comment on PR with results
  comment:
    runs-on: ubuntu-latest
    needs: verify
    if: >
      github.event_name == 'pull_request' && 
      (github.head_ref == 'Manas1820:chore/update-blocklist' || github.head_ref == 'chore/update-blocklist') &&
      github.event.pull_request.head.repo.owner.login == 'Manas1820'

    permissions:
      pull-requests: write

    steps:
      - name: Download log artifact
        uses: actions/download-artifact@v4
        with:
          name: verification-log
          path: .
        continue-on-error: true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## üîç Domain Verification Results\n\n';

            try {
              const log = fs.readFileSync('verification.log', 'utf8');
              const lines = log.split('\n');
              
              // Find RESULTS line
              const resultsLine = lines.find(l => l.includes('RESULTS:'));
              if (resultsLine) {
                body += `### üìä Final Results\n**${resultsLine.split('RESULTS:')[1].trim()}**\n\n`;
              }
              
              // Show skipped count
              const skippedLine = lines.find(l => l.includes('Skipping') && l.includes('existing screenshots'));
              if (skippedLine) {
                const match = skippedLine.match(/Skipping (\d+) domains/);
                if (match) body += `‚ÑπÔ∏è Skipped ${match[1]} domains with existing screenshots\n\n`;
              }
              
              // Find MATCH FOUND lines
              const matches = lines.filter(l => l.includes('MATCH FOUND:'));
              body += '### ‚úÖ Found Domains\n';
              if (matches.length > 0) {
                matches.forEach(m => {
                  const domain = m.match(/MATCH FOUND: (\S+)/)?.[1];
                  if (domain) body += `- \`${domain}\`\n`;
                });
              } else {
                body += '_No new domains found in this run_\n';
              }
              body += '\n';
              
              // Show not found in collapsible
              const notFoundLine = lines.find(l => l.includes('Not found'));
              if (notFoundLine) {
                const match = notFoundLine.match(/Not found \((\d+)\)/);
                if (match) {
                  body += `### ‚ùå Not Found (${match[1]})\n`;
                  body += '<details><summary>Click to expand</summary>\n\n';
                  const domainsMatch = notFoundLine.match(/\[([^\]]+)\]/);
                  if (domainsMatch) {
                    const domains = domainsMatch[1].replace(/'/g, '').split(', ');
                    domains.forEach(d => body += `- \`${d.trim()}\`\n`);
                  }
                  body += '</details>\n\n';
                }
              }
              
              body += 'üìã See workflow artifacts for full log';
            } catch (e) {
              body += 'No verification results available. Check workflow logs for details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
